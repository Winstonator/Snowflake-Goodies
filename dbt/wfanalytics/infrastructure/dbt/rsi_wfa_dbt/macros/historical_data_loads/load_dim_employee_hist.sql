{% macro load_dim_employee_hist() %}
    {% do log("Creating historical load for dim employee", info=True) %}

        {% set sql %}
            CREATE TABLE IF NOT EXISTS {{target.database}}.CORE.DIM_EMPLOYEE AS (
                with rawdata as (
                select RPT_EFFECTIVE_DT, EIN as EMP_ID,	Worker as WORKER,	Position_ID as POSITION_ID,	Job_Code as JOB_CD,	Cost_Center_ID as COST_CENTER_ID,	Worker_WID as WORKER_WID,	Worker_Type as WORKER_TYPE,	Employee_Type as EMP_TYPE,	Status as STATUS,	Active_Status as ACTIVE_STATUS,	Total_FTE as TOTAL_FTE,	FTE_Percent as FTE_PCT,	Time_Type as TIME_TYPE,	Default_Weekly_Hours as DEFAULT_WEEKLY_HRS,	Is_Rehire as IS_REHIRE,	Hire_DT as HIRE_DT,	Original_Hire_DT as ORIGINAL_HIRE_DT,	Seniority_DT as SENIORITY_DT,	Continuous_service_DT_SENS as CONTINUOUS_SERVICE_DT_SENS,	Time_Off_Service_DT as TIME_OFF_SERVICE_DT,	Pay_Through_DT as PAY_THROUGH_DT,	Last_Day_of_Work_DT as LAST_DAY_OF_WORK_DT,	Vesting_DT_SENS as VESTING_DT_SENS,	Termination_DT as TERM_DT,	Termination_Reason_SENS as TERM_REASON_SENS,	Eligible_for_Rehire_SENS as ELIGIBLE_FOR_REHIRE_SENS,	Cost_To_Replace_SENS as COST_TO_REPLACE_SENS,	Costing_Allocation_Exists_for_Worker as COSTING_ALLOCATION_EXISTS_FOR_WORKER,	Pay_Group as PAY_GROUP,	Pay_Rate_Type as PAY_RATE_TYPE,	Pay_Types_Without_Payment_Election as PAY_TYPES_WITHOUT_PYMT_ELECTION,	Total_Base_Pay_Payroll_SENS as TOTAL_BASE_PAY_PAYROLL_SENS,	Total_Pay_Amt_SENS as TOTAL_PAY_AMT_SENS,	Hourly_Rate_Amt_SENS as HRLY_RATE_AMT_SENS,	User_Name as USER_NAME,	Email_Work as EMAIL_WORK,	Primary_Work_Mobile_Phone as PRIM_WORK_MOBILE_PHONE,	Primary_Work_Phone as PRIM_WORK_PHONE,	Work_Phones as WORK_PHONES,	Worker_has_Photo as WORKER_HAS_PHOTO,	Full_Legal_Name as FULL_LEGAL_NAME,	Legal_Name_is_Preferred_Name as LEGAL_NAME_IS_PREF_NAME,	Legal_First_Name as LEGAL_FIRST_NAME,	Legal_Last_Name as LEGAL_LAST_NAME,	Legal_Name_Middle_Name as LEGAL_MIDDLE_NAME,	Legal_Name_Secondary_Last_Name as LEGAL_SECONDARY_LAST_NAME,	Legal_Name_Social_Suffix as LEGAL_SOCIAL_SUFFIX,	Legal_Name_Title as LEGAL_TITLE,	Preferred_Name as PREF_NAME,	Preferred_Name_First_Name as PREF_FIRST_NAME,	Preferred_Name_Last_Name as PREF_LAST_NAME,	Preferred_Name_Middle_Name as PREF_MIDDLE_NAME,	Preferred_Name_Secondary_Last_Name as PREF_SECONDARY_LAST_NAME,	Preferred_Name_Social_Suffix as PREF_SOCIAL_SUFFIX,	Primary_Address_Formatted_Line_1_PII as PRIM_ADDRESS_LINE_1_PII,	Primary_Address_Formatted_Line_2_PII as PRIM_ADDRESS_LINE_2_PII,	Primary_Address_Formatted_Line_3_PII as PRIM_ADDRESS_LINE_3_PII,	Primary_Address_Formatted_Line_4_PII as PRIM_ADDRESS_LINE_4_PII,	Primary_Address_Postal_Cd_PII as PRIM_POSTAL_CD_PII,	Primary_Address_State_Province as PRIM_STATE_PROVINCE,	Primary_Home_Address_City_PII as PRIM_CITY_PII,	All_Home_Addresses_Full_with_Country_PII as ALL_HOME_ADDRESSES_PII,	Phone_Nums_SENS as PHONE_NBRS_SENS,	Mobile_Phones_SENS as MOBILE_PHONES_SENS,	Email_Home_PII as EMAIL_HOME_PII,	SSN_PII as SSN_PII,	Other_IDs_PII as OTHER_IDS_PII,	Birth_DT_PII as BIRTH_DT_PII,	Generation_SENS as GENERATION_SENS,	Gender_SENS as GENDER_SENS,	Ethnicity_Code_SENS as ETHNICITY_CD_SENS,	Hispanic_or_Latino_SENS as HISPANIC_OR_LATINO_SENS,	Hispanic_or_Latino_Visual_Survey_SENS as HISPANIC_OR_LATINO_VISUAL_SURVEY_SENS,	EEO_Race_SENS as EEO_RACE_SENS,	EEO_Race_Visual_Survey_SENS as EEO_RACE_VISUAL_SURVEY_SENS,	Veteran_Status_Identification_SENS as VETERAN_STATUS_ID_SENS,	Latest_External_Disability_Response_Record_SENS as LATEST_EXT_DISABILITY_RESPONSE_REC_SENS,	Latest_External_Disability_Status_SENS as LATEST_EXT_DISABILITY_STATUS_SENS,	Latest_External_Response_Date_of_Disability_Self_Identification_SENS as LATEST_EXT_RESPONSE_DT_OF_DISABILITY_SELF_ID_SENS,
                row_number() over(partition by EIN,	Worker,	Position_ID,	Job_Code,	Cost_Center_ID,	Worker_WID,	Worker_Type,	Employee_Type,	Status,	Active_Status,	Total_FTE,	FTE_Percent,	Time_Type,	Default_Weekly_Hours,	Is_Rehire,	Hire_DT,	Original_Hire_DT,	Seniority_DT,	Continuous_service_DT_SENS,	Time_Off_Service_DT,	Pay_Through_DT,	Last_Day_of_Work_DT,	Vesting_DT_SENS,	Termination_DT,	Termination_Reason_SENS,	Eligible_for_Rehire_SENS,	Cost_To_Replace_SENS,	Costing_Allocation_Exists_for_Worker,	Pay_Group,	Pay_Rate_Type,	Pay_Types_Without_Payment_Election,	Total_Base_Pay_Payroll_SENS,	Total_Pay_Amt_SENS,	Hourly_Rate_Amt_SENS,	User_Name,	Email_Work,	Primary_Work_Mobile_Phone,	Primary_Work_Phone,	Work_Phones,	Worker_has_Photo,	Full_Legal_Name,	Legal_Name_is_Preferred_Name,	Legal_First_Name,	Legal_Last_Name,	Legal_Name_Middle_Name,	Legal_Name_Secondary_Last_Name,	Legal_Name_Social_Suffix,	Legal_Name_Title,	Preferred_Name,	Preferred_Name_First_Name,	Preferred_Name_Last_Name,	Preferred_Name_Middle_Name,	Preferred_Name_Secondary_Last_Name,	Preferred_Name_Social_Suffix,	Primary_Address_Formatted_Line_1_PII,	Primary_Address_Formatted_Line_2_PII,	Primary_Address_Formatted_Line_3_PII,	Primary_Address_Formatted_Line_4_PII,	Primary_Address_Postal_Cd_PII,	Primary_Address_State_Province,	Primary_Home_Address_City_PII,	All_Home_Addresses_Full_with_Country_PII,	Phone_Nums_SENS,	Mobile_Phones_SENS,	Email_Home_PII,	SSN_PII,	Other_IDs_PII,	Birth_DT_PII,	Generation_SENS,	Gender_SENS,	Ethnicity_Code_SENS,	Hispanic_or_Latino_SENS,	Hispanic_or_Latino_Visual_Survey_SENS,	EEO_Race_SENS,	EEO_Race_Visual_Survey_SENS,	Veteran_Status_Identification_SENS,	Latest_External_Disability_Response_Record_SENS,	Latest_External_Disability_Status_SENS,	Latest_External_Response_Date_of_Disability_Self_Identification_SENS order by RPT_EFFECTIVE_DT ) as rn 
                FROM {{ source('STAGING','STG_WKD_EMPLOYEE_EXTRACT') }} 
                QUALIFY RN=1
                ) 
                , version as (
                select *, row_number() over(partition by EMP_ID order by RPT_EFFECTIVE_DT asc) as version_number from rawdata
                ) 
                , final as (
                select v1.*, v1.RPT_EFFECTIVE_DT as EFF_DT, v2.RPT_EFFECTIVE_DT -1  as DISC_DT
                from version v1 
                left join version v2 on v1.version_number +1 =v2.version_number and v1.EMP_ID = v2.EMP_ID 
                order by v1.version_number
                ) 
                select 
                 {{ dbt_utils.surrogate_key(['EMP_ID','RPT_EFFECTIVE_DT'])}} as EMP_SK,
                    EMP_ID,	WORKER,	POSITION_ID,	JOB_CD,	COST_CENTER_ID,	WORKER_WID,	WORKER_TYPE,	EMP_TYPE,	STATUS,	ACTIVE_STATUS,	TOTAL_FTE,	FTE_PCT,	TIME_TYPE,	DEFAULT_WEEKLY_HRS,	IS_REHIRE,	HIRE_DT,	ORIGINAL_HIRE_DT,	SENIORITY_DT,	CONTINUOUS_SERVICE_DT_SENS,	TIME_OFF_SERVICE_DT,	PAY_THROUGH_DT,	LAST_DAY_OF_WORK_DT,	VESTING_DT_SENS,	TERM_DT,	TERM_REASON_SENS,	ELIGIBLE_FOR_REHIRE_SENS,	COST_TO_REPLACE_SENS,	COSTING_ALLOCATION_EXISTS_FOR_WORKER,	PAY_GROUP,	PAY_RATE_TYPE,	PAY_TYPES_WITHOUT_PYMT_ELECTION,	TOTAL_BASE_PAY_PAYROLL_SENS,	TOTAL_PAY_AMT_SENS,	HRLY_RATE_AMT_SENS,	USER_NAME,	EMAIL_WORK,	PRIM_WORK_MOBILE_PHONE,	PRIM_WORK_PHONE,	WORK_PHONES,	WORKER_HAS_PHOTO,	FULL_LEGAL_NAME,	LEGAL_NAME_IS_PREF_NAME,	LEGAL_FIRST_NAME,	LEGAL_LAST_NAME,	LEGAL_MIDDLE_NAME,	LEGAL_SECONDARY_LAST_NAME,	LEGAL_SOCIAL_SUFFIX,	LEGAL_TITLE,	PREF_NAME,	PREF_FIRST_NAME,	PREF_LAST_NAME,	PREF_MIDDLE_NAME,	PREF_SECONDARY_LAST_NAME,	PREF_SOCIAL_SUFFIX,	PRIM_ADDRESS_LINE_1_PII,	PRIM_ADDRESS_LINE_2_PII,	PRIM_ADDRESS_LINE_3_PII,	PRIM_ADDRESS_LINE_4_PII,	PRIM_POSTAL_CD_PII,	PRIM_STATE_PROVINCE,	PRIM_CITY_PII,	ALL_HOME_ADDRESSES_PII,	PHONE_NBRS_SENS,	MOBILE_PHONES_SENS,	EMAIL_HOME_PII,	SSN_PII,	OTHER_IDS_PII,	BIRTH_DT_PII,	GENERATION_SENS,	GENDER_SENS,	ETHNICITY_CD_SENS,	HISPANIC_OR_LATINO_SENS,	HISPANIC_OR_LATINO_VISUAL_SURVEY_SENS,	EEO_RACE_SENS,	EEO_RACE_VISUAL_SURVEY_SENS,	VETERAN_STATUS_ID_SENS,	LATEST_EXT_DISABILITY_RESPONSE_REC_SENS,	LATEST_EXT_DISABILITY_STATUS_SENS,	LATEST_EXT_RESPONSE_DT_OF_DISABILITY_SELF_ID_SENS, 
                    RPT_EFFECTIVE_DT,
                    'WKD' AS REC_SRC,
                    EFF_DT, 
                    coalesce(DISC_DT, '9999-12-31') as DISC_DT, 
                    CASE WHEN DISC_DT is null then TRUE else FALSE END as IS_CURRENT,         
                    (select to_number(to_varchar(current_timestamp, 'yyyymmddhh24miss'))) as INS_BATCH_ID,
                    TO_NUMBER(to_varchar(CURRENT_TIMESTAMP, 'YYYYMMDDHH24MISS')) AS UPD_BATCH_ID,
                    {{ dbt_utils.surrogate_key(['WORKER',	'POSITION_ID',	'JOB_CD',	'COST_CENTER_ID',	'WORKER_WID',	'WORKER_TYPE',	'EMP_TYPE',	'STATUS',	'ACTIVE_STATUS',	'TOTAL_FTE',	'FTE_PCT',	'TIME_TYPE',	'DEFAULT_WEEKLY_HRS',	'IS_REHIRE',	'HIRE_DT',	'ORIGINAL_HIRE_DT',	'SENIORITY_DT',	'CONTINUOUS_SERVICE_DT_SENS',	'TIME_OFF_SERVICE_DT',	'PAY_THROUGH_DT',	'LAST_DAY_OF_WORK_DT',	'VESTING_DT_SENS',	'TERM_DT',	'TERM_REASON_SENS',	'ELIGIBLE_FOR_REHIRE_SENS',	'COST_TO_REPLACE_SENS',	'COSTING_ALLOCATION_EXISTS_FOR_WORKER',	'PAY_GROUP',	'PAY_RATE_TYPE',	'PAY_TYPES_WITHOUT_PYMT_ELECTION',	'TOTAL_BASE_PAY_PAYROLL_SENS',	'TOTAL_PAY_AMT_SENS',	'HRLY_RATE_AMT_SENS',	'USER_NAME',	'EMAIL_WORK',	'PRIM_WORK_MOBILE_PHONE',	'PRIM_WORK_PHONE',	'WORK_PHONES',	'WORKER_HAS_PHOTO',	'FULL_LEGAL_NAME',	'LEGAL_NAME_IS_PREF_NAME',	'LEGAL_FIRST_NAME',	'LEGAL_LAST_NAME',	'LEGAL_MIDDLE_NAME',	'LEGAL_SECONDARY_LAST_NAME',	'LEGAL_SOCIAL_SUFFIX',	'LEGAL_TITLE',	'PREF_NAME',	'PREF_FIRST_NAME',	'PREF_LAST_NAME',	'PREF_MIDDLE_NAME',	'PREF_SECONDARY_LAST_NAME',	'PREF_SOCIAL_SUFFIX',	'PRIM_ADDRESS_LINE_1_PII',	'PRIM_ADDRESS_LINE_2_PII',	'PRIM_ADDRESS_LINE_3_PII',	'PRIM_ADDRESS_LINE_4_PII',	'PRIM_POSTAL_CD_PII',	'PRIM_STATE_PROVINCE',	'PRIM_CITY_PII',	'ALL_HOME_ADDRESSES_PII',	'PHONE_NBRS_SENS',	'MOBILE_PHONES_SENS',	'EMAIL_HOME_PII',	'SSN_PII',	'OTHER_IDS_PII',	'BIRTH_DT_PII',	'GENERATION_SENS',	'GENDER_SENS',	'ETHNICITY_CD_SENS',	'HISPANIC_OR_LATINO_SENS',	'HISPANIC_OR_LATINO_VISUAL_SURVEY_SENS',	'EEO_RACE_SENS',	'EEO_RACE_VISUAL_SURVEY_SENS',	'VETERAN_STATUS_ID_SENS',	'LATEST_EXT_DISABILITY_RESPONSE_REC_SENS',	'LATEST_EXT_DISABILITY_STATUS_SENS',	'LATEST_EXT_RESPONSE_DT_OF_DISABILITY_SELF_ID_SENS']) }} AS DBT_HASH

                from final
                )

        {% endset %}
        
        {{ return(sql) }}

        {% do log("historical dim employee table created", info=True) %}

{% endmacro %}
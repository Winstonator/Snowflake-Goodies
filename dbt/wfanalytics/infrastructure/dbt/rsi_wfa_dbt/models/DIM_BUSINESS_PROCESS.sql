{{
    config(
        materialized='incremental',
        unique_key ='BP_SK',
        full_refresh = false
        )
}}

WITH
STG_WKD_BUSINESS_PROCESS AS (
    SELECT *, 'WKD' AS REC_SOURCE
    FROM {{ source('STAGING','STG_WKD_BUSINESS_PROCESS') }}
) 

SELECT
    {{ dbt_utils.surrogate_key(['BP_ID','BP_STEP_WID','CUSTOMER_NOTIFICATION_WID2']) }} AS BP_SK,
    BP_ID,
    BP_FUNCTIONAL_AREA,
    BP_TYPE,
    BP_DEF,
    BP_DEFAULT_DEF_IND,
    BP_TYPE_DESC,
    BP_DUE_TIME_FRAME,
    BP_DUE_PER_EFF_DT_IND,
    BP_INITIATING_SECURITY_GROUPS,
    BP_LAST_UPD_BY,
    BP_LAST_UPD_DTM,
    BP_MOST_RECENTLY_USED_DT,
    BP_WID,
    BP_TYPE_ID,
    BP_TYPE_ATTACHMENTS_ENABLED_IND,
    BP_TYPE_WID,
    BP_STEP_ID,
    BP_STEP_ORDER,
    BP_STEP_TYPE,
    BP_STEP_WORKFLOW,
    BP_STEP_TASK,
    BP_STEP_VALIDATION_CONDITIONS,
    BP_STEP_ENTRY_CONDITIONS_AND_ALLOWED_ACTIONS,
    BP_STEP_SECURITY_GROUPS,
    BP_STEP_HELP_TEXT,
    BP_STEP_COMPLETION_IND,
    BP_STEP_OPTIONAL_IND,
    BP_STEP_TO_DO,
    BP_STEP_REPORT,
    BP_STEP_SERVICE,
    BP_STEP_INTEGRATION_SYSTEM,
    BP_STEP_WF_REVIEW_DOCS,
    BP_STEP_ROUTING_RSTRCTNS_EXCL_INITIATOR_IND,
    BP_STEP_ROUTING_RSTRCTNS_EXCL_PRIOR_APPROVER_IND,
    BP_STEP_ROUTING_RSTRCTNS_EXCL_EVENT_WORKER_IND,
    BP_STEP_ROUTING_RSTRCTNS_ALT_SECURITY_GROUPS,
    BP_STEP_ROUTING_RSTRCTNS_ALT_SECURITY_GROUPS_EXCL_USERS_IND,
    BP_STEP_RUN_AS_USER,
    BP_STEP_DUE_TIME_FRAME,
    BP_STEP_DUE_DT_PER_EFF_DT_IND,
    BP_STEP_DELAY_TIME_FRAME,
    BP_STEP_SYS_NOTIFY_DISABLED_IND,
    BP_STEP_LAST_FUNC_UPD_DTM,
    BP_STEP_WID,
    CUST_NOTIFICATION_ID,
    CUST_NOTIFICATION_DESC,
    CUST_NOTIFICATION_SUBJECT,
    CUST_NOTIFICATION_BODY,
    CUST_NOTIFICATION_RECIPIENTS,
    CUST_NOTIFICATION_EMAIL_OPTION,
    CUST_NOTIFICATION_WF_TRIGGER,
    CUST_NOTIFICATION_CONDITIONS,
    CUST_NOTIFICATION_LAST_FUNCTIONALLY_UPD_DTM,
    CUST_NOTIFICATION_WID,
    INS_BATCH_ID,
    UPD_BATCH_ID,
    REC_SRC
FROM
(
SELECT
NVL(CUSTOMER_NOTIFICATION_WID,'NULL') AS CUSTOMER_NOTIFICATION_WID2,
BP_REFID AS BP_ID,
BP_FUNCTIONAL_AREA AS BP_FUNCTIONAL_AREA,
BP_TYPE AS BP_TYPE,
BP_DEFINITION AS BP_DEF,
BP_DEFAULT_DEFINITION_IND AS BP_DEFAULT_DEF_IND,
BP_TYPE_DESCRIPTION AS BP_TYPE_DESC,
BP_DUE_TIME_FRAME AS BP_DUE_TIME_FRAME,
BP_DUE_PER_EFFECTIVE_DT_IND AS BP_DUE_PER_EFF_DT_IND,
BP_INITIATING_SECURITY_GROUPS AS BP_INITIATING_SECURITY_GROUPS,
BP_LAST_UPD_BY AS BP_LAST_UPD_BY,
BP_LAST_UPD_DTM AS BP_LAST_UPD_DTM,
BP_MOST_RECENTLY_USED_DT AS BP_MOST_RECENTLY_USED_DT,
BP_WID AS BP_WID,
BP_TYPE_REFID AS BP_TYPE_ID,
BP_TYPE_ATTACHMENTS_ENABLED_IND AS BP_TYPE_ATTACHMENTS_ENABLED_IND,
BP_TYPE_WID AS BP_TYPE_WID,
BP_STEP_REFID AS BP_STEP_ID,
BP_STEP_ORDER AS BP_STEP_ORDER,
BP_STEP_TYPE AS BP_STEP_TYPE,
BP_STEP_WORKFLOW AS BP_STEP_WORKFLOW,
BP_STEP_TASK AS BP_STEP_TASK,
BP_STEP_VALIDATION_CONDITIONS AS BP_STEP_VALIDATION_CONDITIONS,
BP_STEP_ENTRY_CONDITIONS_AND_ALLOWED_ACTIONS AS BP_STEP_ENTRY_CONDITIONS_AND_ALLOWED_ACTIONS,
BP_STEP_SECURITY_GROUPS AS BP_STEP_SECURITY_GROUPS,
BP_STEP_HELP_TEXT AS BP_STEP_HELP_TEXT,
BP_STEP_COMPLETION_IND AS BP_STEP_COMPLETION_IND,
BP_STEP_OPTIONAL_IND AS BP_STEP_OPTIONAL_IND,
BP_STEP_TO_DO AS BP_STEP_TO_DO,
BP_STEP_REPORT AS BP_STEP_REPORT,
BP_STEP_SERVICE AS BP_STEP_SERVICE,
BP_STEP_INTEGRATION_SYSTEM AS BP_STEP_INTEGRATION_SYSTEM,
BP_STEP_WF_REVIEW_DOCS AS BP_STEP_WF_REVIEW_DOCS,
BP_STEP_ROUTING_RSTRCTNS_EXCL_INITIATOR_IND AS BP_STEP_ROUTING_RSTRCTNS_EXCL_INITIATOR_IND,
BP_STEP_ROUTING_RSTRCTNS_EXCL_PRIOR_APPROVER_IND AS BP_STEP_ROUTING_RSTRCTNS_EXCL_PRIOR_APPROVER_IND,
BP_STEP_ROUTING_RSTRCTNS_EXCL_EVENT_WORKER_IND AS BP_STEP_ROUTING_RSTRCTNS_EXCL_EVENT_WORKER_IND,
BP_STEP_ROUTING_RSTRCTNS_ALT_SECURITY_GROUPS AS BP_STEP_ROUTING_RSTRCTNS_ALT_SECURITY_GROUPS,
BP_STEP_ROUTING_RSTRCTNS_ALT_SECURITY_GROUPS_EXCL_USERS_IND AS BP_STEP_ROUTING_RSTRCTNS_ALT_SECURITY_GROUPS_EXCL_USERS_IND,
BP_STEP_RUN_AS_USER AS BP_STEP_RUN_AS_USER,
BP_STEP_DUE_TIME_FRAME AS BP_STEP_DUE_TIME_FRAME,
BP_STEP_DUE_DT_PER_EFFECTIVE_DT_IND AS BP_STEP_DUE_DT_PER_EFF_DT_IND,
BP_STEP_DELAY_TIME_FRAME AS BP_STEP_DELAY_TIME_FRAME,
BP_STEP_SYS_NOTIFY_DISABLED_IND AS BP_STEP_SYS_NOTIFY_DISABLED_IND,
BP_STEP_LAST_FUNC_UPD_DTM AS BP_STEP_LAST_FUNC_UPD_DTM,
BP_STEP_WID AS BP_STEP_WID,
CUSTOMER_NOTIFICATION_REFID AS CUST_NOTIFICATION_ID,
CUSTOMER_NOTIFICATION_DESCRIPTION AS CUST_NOTIFICATION_DESC,
CUSTOMER_NOTIFICATION_SUBJECT AS CUST_NOTIFICATION_SUBJECT,
CUSTOMER_NOTIFICATION_BODY AS CUST_NOTIFICATION_BODY,
CUSTOMER_NOTIFICATION_RECIPIENTS AS CUST_NOTIFICATION_RECIPIENTS,
CUSTOMER_NOTIFICATION_EMAIL_OPTION AS CUST_NOTIFICATION_EMAIL_OPTION,
CUSTOMER_NOTIFICATION_WF_TRIGGER AS CUST_NOTIFICATION_WF_TRIGGER,
CUSTOMER_NOTIFICATION_CONDITIONS AS CUST_NOTIFICATION_CONDITIONS,
CUSTOMER_NOTIFICATION_LAST_FUNCTIONALLY_UPD_DTM AS CUST_NOTIFICATION_LAST_FUNCTIONALLY_UPD_DTM,
CUSTOMER_NOTIFICATION_WID AS CUST_NOTIFICATION_WID,
TO_NUMBER(TO_VARCHAR(CURRENT_TIMESTAMP, 'YYYYMMDDHH24MISS')) as INS_BATCH_ID,
TO_NUMBER(TO_VARCHAR(CURRENT_TIMESTAMP, 'YYYYMMDDHH24MISS')) AS UPD_BATCH_ID,
REC_SOURCE AS REC_SRC
FROM STG_WKD_BUSINESS_PROCESS
QUALIFY ROW_NUMBER() OVER(PARTITION BY BP_REFID, BP_STEP_WID, NVL(CUSTOMER_NOTIFICATION_WID,'NULL')
                            ORDER BY SF_INSERT_TIMESTAMP::DATE DESC) = 1
)
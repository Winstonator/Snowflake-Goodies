{{
    config(
        materialized='table',
        tags=["core","dim","scheduled-daily"],
        full_refresh=True
    )
}}

WITH 
RAW_DATA AS ( SELECT
    POSITION_ID AS POSITION_ID,
    DESCRIPTION AS POSITION_DESC,
    EIN AS EMP_ID,
    MANAGER_ID AS MGR_ID,
    ORG_ID AS SUP_ORG_ID,
    COST_CENTER AS COST_CENTER,
    JOB_CODE AS JOB_CD,
    POSITION_RESTRICTION_WID AS POSITION_RESTRICTION_WID, 
    POSITION_MANAGEMENT_WID AS POSITION_MGMT_WID,
    POSITION_FILLED_WID AS POSITION_FILLED_WID,
    COMPLETED_CREATE_POSITION_PROCESS_WID AS COMPLETED_CREATE_POSITION_PROCESS_WID,
    STAFFING_STATUS AS STAFFING_STATUS,
    POSITION_OPEN_REASON AS POSITION_OPEN_REASON,
    DYNAMIC_MANAGEMENT_LEVEL AS DYNAMIC_MGMT_LEVEL,
    ORGANIZATION_ASSIGNMENTS AS ORG_ASSIGNMENTS,
    MANAGER_POSITION AS MGR_POSITION,
    COSTING_ALLOCATION_WORKTAGS_FOR_POSITION AS COSTING_ALLOCATION_WORKTAGS_FOR_POSITION,
    ADD_EMPLOYMENT_BP AS ADD_EMPLOYMENT_BP,
    ADD_EMPLOYMENT_BP_REASON AS ADD_EMPLOYMENT_BP_REASON,
    WORKERS_COMPENSATION_CD AS WORKERS_COMP_CD, 
    UNION_MEMBERSHIP AS UNION_MEMBERSHIP,
    ALLOWED_UNIONS AS ALLOWED_UNIONS,
    FTE AS FTE,
    FTE_PERCENT AS FTE_PERCENT,
    SCHEDULED_WEEKLY_HOURS AS SCHEDULED_WEEKLY_HRS,
    WORK_SHIFT AS WORK_SHIFT,
    COMPANY_INSIDER_TYPES_FOR_POSITION_ELEMENT AS COMPANY_INSIDER_TYPES_FOR_POSITION_ELEMENT,
    POSITION_EFFECTIVE_DT AS POSITION_EFF_DT,
    POSITION_VACATE_DT AS POSITION_VACATE_DT,
    EARLIEST_HIRE_DT AS EARLIEST_HIRE_DT,
    AVAILABILITY_DT AS AVAILABILITY_DT,
    AVAILABLE_FOR_OVERLAP_IND AS AVAILABLE_FOR_OVERLAP_IND,
    AVAILABLE_FOR_RECRUITING_IND AS AVAILABLE_FOR_RECRUITING_IND,
    AVAILABLE_FOR_HIRE_IND AS AVAILABLE_FOR_HIRE_IND,
    CLOSED_TO_HIRE_IND AS CLOSED_TO_HIRE_IND,
    HIRING_RESTRICTIONS_LOCATION AS HIRING_RESTRICTIONS_LOCATION,
    HIRING_RESTRICTIONS_POSITION_WORKER_TYPE AS HIRING_RESTRICTIONS_POSTION_WORKER_TYPE,
    HIRING_RESTRICTIONS_TIME_TYPE AS HIRING_RESTRICTIONS_TIME_TYPE,
    HIRING_REQUIREMENT AS HIRING_REQUIREMENT,
    OPEN_JOB_REQUISITION AS	OPEN_JOB_REQ,
    DIFFICULTY_TO_FILL AS DIFFICULTY_TO_FILL,
    FROZEN AS FROZEN,
    FREEZE_DT AS FREEZE_DT,
    FREEZE_REASON AS FREEZE_REASON,
    HIRING_FREEZE AS HIRING_FREEZE,
    FUTURE_POSITION_FILL_EFFECTIVE_DT AS FUTURE_POSITION_FILL_EFF_DT,
    FUTURE_POSITION_FILL_WORKER_EIN AS FUTURE_POSITION_FILL_WORKER_EMP_ID,
    HAS_FUTURE_POSITION_FILL_IND AS HAS_FUTURE_POSITION_FILL_IND,
    HAS_SUCCESSION_PLAN_IND AS HAS_SUCCESSION_PLAN_IND,
    SUCCESSION_PLAN AS SUCCESSION_PLAN,
    SUCCESSION_READINESS AS SUCCESSION_READINESS,
    IS_OVERLAPPED_POSITION_IND AS OVERLAPPED_POSITION_IND,
    IS_OVERLAP_POSITION_IND AS IS_OVERLAP_POSITION_IND,
    HAS_OVERLAP_WORKER_IND AS HAS_OVERLAP_WORKER_IND,
    OVERLAP_POSITION AS OVERLAP_POSITION,
    OVERLAP_TYPE AS OVERLAP_TYPE,
    PAY_GROUP AS PAY_GROUP,
    PAY_RATE_TYPE AS PAY_RATE_TYPE,
    POSITION_COMPENSATION_PLAN AS POSITION_COMP_PLAN,
    POSITION_BASE_PAY_RANGE_SEGMENT_EFFECTIVE AS POSITION_BASE_PAY_RANGE_SEGMENT_EFF,
    POSITION_COMPENSATION_GRADE AS POSITION_COMP_GRADE,
    POSITION_COMPENSATION_GRADE_PROFILE AS POSITION_COMP_GRADE_PROFILE,
    POSITION_COMPENSATION_COMPONENT_TYPES AS POSITION_COMP_COMPONENT_TYPES,
    POSITION_COMPENSATION_COMPONENTS AS POSITION_COMP_COMPONENTS,
    POSITION_CALCULATED_PLAN_ASSIGNMENT_DETAILS AS POSITION_CALC_PLAN_ASSIGNMENT_DTL,
    ACTION_EVENT AS ACTION_EVENT,
    CREATED_DTM AS CREATED_DTM,
    CREATED_BY AS CREATED_BY,
    MOST_RECENT_PAY_GROUP_ASSIGNMENT_CHANGE,
    MOST_RECENT_POSITION_CHANGE,
    MOST_RECENT_SUPERVISORY_ORGANIZATION_CHANGE,
    MOST_RECENT_STAFFING_SNAPSHOT_CHANGE,
    MOST_RECENT_BUSINESS_TITLE_CHANGE,
    MOST_RECENT_PAY_GROUP_CHANGE,
    COMPENSATION_MOST_RECENT_CHANGE_DT,
    RPT_EFFECTIVE_DT AS RPT_EFF_DT,
    ROW_NUMBER() OVER (PARTITION BY POSITION_ID
        ORDER BY RPT_EFFECTIVE_DT) AS RN
    FROM {{ ref('STG_WKD_POSITION_INTERIM') }}
),

RNO_LOAD AS (
    select *
    , ROW_NUMBER() OVER (PARTITION BY
        POSITION_ID,
        POSITION_DESC,
        EMP_ID,
        MGR_ID,
        SUP_ORG_ID,
        COST_CENTER,
        JOB_CD,
        POSITION_RESTRICTION_WID,
        POSITION_MGMT_WID,
        POSITION_FILLED_WID,
        COMPLETED_CREATE_POSITION_PROCESS_WID,
        STAFFING_STATUS,
        POSITION_OPEN_REASON,
        DYNAMIC_MGMT_LEVEL,
        ORG_ASSIGNMENTS,
        MGR_POSITION,
        COSTING_ALLOCATION_WORKTAGS_FOR_POSITION,
        ADD_EMPLOYMENT_BP,
        ADD_EMPLOYMENT_BP_REASON,
        WORKERS_COMP_CD,
        UNION_MEMBERSHIP,
        ALLOWED_UNIONS,
        FTE,
        FTE_PERCENT,
        SCHEDULED_WEEKLY_HRS,
        WORK_SHIFT,
        COMPANY_INSIDER_TYPES_FOR_POSITION_ELEMENT,
        POSITION_EFF_DT,
        POSITION_VACATE_DT,
        EARLIEST_HIRE_DT,
        AVAILABILITY_DT,
        AVAILABLE_FOR_OVERLAP_IND,
        AVAILABLE_FOR_RECRUITING_IND,
        AVAILABLE_FOR_HIRE_IND,
        CLOSED_TO_HIRE_IND,
        HIRING_RESTRICTIONS_LOCATION,
        HIRING_RESTRICTIONS_POSTION_WORKER_TYPE,
        HIRING_RESTRICTIONS_TIME_TYPE,
        HIRING_REQUIREMENT,
        OPEN_JOB_REQ,
        DIFFICULTY_TO_FILL,
        FROZEN,
        FREEZE_DT,
        FREEZE_REASON,
        HIRING_FREEZE,
        FUTURE_POSITION_FILL_EFF_DT,
        FUTURE_POSITION_FILL_WORKER_EMP_ID,
        HAS_FUTURE_POSITION_FILL_IND,
        HAS_SUCCESSION_PLAN_IND,
        SUCCESSION_PLAN,
        SUCCESSION_READINESS,
        OVERLAPPED_POSITION_IND,
        IS_OVERLAP_POSITION_IND,
        HAS_OVERLAP_WORKER_IND,
        OVERLAP_POSITION,
        OVERLAP_TYPE,
        PAY_GROUP,
        PAY_RATE_TYPE,
        POSITION_COMP_PLAN,
        POSITION_BASE_PAY_RANGE_SEGMENT_EFF,
        POSITION_COMP_GRADE,
        POSITION_COMP_GRADE_PROFILE,
        POSITION_COMP_COMPONENT_TYPES,
        POSITION_COMP_COMPONENTS,
        POSITION_CALC_PLAN_ASSIGNMENT_DTL,
        ACTION_EVENT,
        CREATED_DTM,
        CREATED_BY,
        MOST_RECENT_PAY_GROUP_ASSIGNMENT_CHANGE,
        MOST_RECENT_POSITION_CHANGE,
        MOST_RECENT_SUPERVISORY_ORGANIZATION_CHANGE,
        MOST_RECENT_STAFFING_SNAPSHOT_CHANGE,
        MOST_RECENT_BUSINESS_TITLE_CHANGE,
        MOST_RECENT_PAY_GROUP_CHANGE,
        COMPENSATION_MOST_RECENT_CHANGE_DT ORDER BY RN, RPT_EFF_DT ASC) AS RNO
    from RAW_DATA
),

DE_DUP AS (
    SELECT *,
        ROW_NUMBER() OVER (PARTITION BY POSITION_ID,
        POSITION_DESC,
        EMP_ID,
        MGR_ID,
        SUP_ORG_ID,
        COST_CENTER,
        JOB_CD,
        POSITION_RESTRICTION_WID,
        POSITION_MGMT_WID,
        POSITION_FILLED_WID,
        COMPLETED_CREATE_POSITION_PROCESS_WID,
        STAFFING_STATUS,
        POSITION_OPEN_REASON,
        DYNAMIC_MGMT_LEVEL,
        ORG_ASSIGNMENTS,
        MGR_POSITION,
        COSTING_ALLOCATION_WORKTAGS_FOR_POSITION,
        ADD_EMPLOYMENT_BP,
        ADD_EMPLOYMENT_BP_REASON,
        WORKERS_COMP_CD,
        UNION_MEMBERSHIP,
        ALLOWED_UNIONS,
        FTE,
        FTE_PERCENT,
        SCHEDULED_WEEKLY_HRS,
        WORK_SHIFT,
        COMPANY_INSIDER_TYPES_FOR_POSITION_ELEMENT,
        POSITION_EFF_DT,
        POSITION_VACATE_DT,
        EARLIEST_HIRE_DT,
        AVAILABILITY_DT,
        AVAILABLE_FOR_OVERLAP_IND,
        AVAILABLE_FOR_RECRUITING_IND,
        AVAILABLE_FOR_HIRE_IND,
        CLOSED_TO_HIRE_IND,
        HIRING_RESTRICTIONS_LOCATION,
        HIRING_RESTRICTIONS_POSTION_WORKER_TYPE,
        HIRING_RESTRICTIONS_TIME_TYPE,
        HIRING_REQUIREMENT,
        OPEN_JOB_REQ,
        DIFFICULTY_TO_FILL,
        FROZEN,
        FREEZE_DT,
        FREEZE_REASON,
        HIRING_FREEZE,
        FUTURE_POSITION_FILL_EFF_DT,
        FUTURE_POSITION_FILL_WORKER_EMP_ID,
        HAS_FUTURE_POSITION_FILL_IND,
        HAS_SUCCESSION_PLAN_IND,
        SUCCESSION_PLAN,
        SUCCESSION_READINESS,
        OVERLAPPED_POSITION_IND,
        IS_OVERLAP_POSITION_IND,
        HAS_OVERLAP_WORKER_IND,
        OVERLAP_POSITION,
        OVERLAP_TYPE,
        PAY_GROUP,
        PAY_RATE_TYPE,
        POSITION_COMP_PLAN,
        POSITION_BASE_PAY_RANGE_SEGMENT_EFF,
        POSITION_COMP_GRADE,
        POSITION_COMP_GRADE_PROFILE,
        POSITION_COMP_COMPONENT_TYPES,
        POSITION_COMP_COMPONENTS,
        POSITION_CALC_PLAN_ASSIGNMENT_DTL,
        ACTION_EVENT,
        CREATED_DTM,
        CREATED_BY,
        MOST_RECENT_PAY_GROUP_ASSIGNMENT_CHANGE,
        MOST_RECENT_POSITION_CHANGE,
        MOST_RECENT_SUPERVISORY_ORGANIZATION_CHANGE,
        MOST_RECENT_STAFFING_SNAPSHOT_CHANGE,
        MOST_RECENT_BUSINESS_TITLE_CHANGE,
        MOST_RECENT_PAY_GROUP_CHANGE,
        COMPENSATION_MOST_RECENT_CHANGE_DT,
        RN-RNO
        ORDER BY RPT_EFF_DT) AS NUM
    FROM RNO_LOAD
    QUALIFY NUM =1
),

VERSION AS (
    SELECT *, ROW_NUMBER() OVER (PARTITION BY POSITION_ID
        ORDER BY RPT_EFF_DT DESC) AS VERSION_NUMBER
    FROM DE_DUP
),

FINAL AS (
    SELECT V1.*, V1.RPT_EFF_DT AS EFF_DT, V2.RPT_EFF_DT -1  AS FINAL_DISC_DT
    FROM VERSION V1 
    LEFT JOIN VERSION V2 ON V1.VERSION_NUMBER -1 =V2.VERSION_NUMBER 
    AND V1.POSITION_ID = V2.POSITION_ID 
    ORDER BY V1.VERSION_NUMBER
),

-- Get all the POSITION_IDs who have had a has_overlap_worker_ind = 1
OVL_POS AS (
    SELECT f.POSITION_ID as OVL_POSITION_ID
     , f.eff_dt as OVL_EFF_DT
    FROM final f
    WHERE f.has_overlap_worker_ind = 1
    QUALIFY row_number() over (partition by f.position_id, f.eff_dt order by f.eff_dt) = 1
),

OVL_VERSION AS (
    SELECT *, ROW_NUMBER() OVER (PARTITION BY OVL_POSITION_ID ORDER BY OVL_EFF_DT DESC) AS VERSION_NUMBER FROM OVL_POS
),

OVL_FINAL AS (
    SELECT V1.*, V2.OVL_EFF_DT -1 AS FINAL_OVL_DISC_DT
    FROM OVL_VERSION V1 
    LEFT JOIN OVL_VERSION V2 ON V1.VERSION_NUMBER -1 =V2.VERSION_NUMBER 
    AND V1.OVL_POSITION_ID = V2.OVL_POSITION_ID 
    ORDER BY V1.VERSION_NUMBER
),

-- Get all the POSITION_IDs and the has_overlap_worker_ind vaule of the their last record
OVL_FINISH AS (
    SELECT position_id as OVLF_POSITION_ID, has_overlap_worker_ind as OVLF_HAS_OVERLAP_WORKER_IND
    FROM final
    QUALIFY row_number() over (partition by position_id order by eff_dt desc) = 1
)

SELECT 
    {{ dbt_utils.surrogate_key(['POSITION_ID','RPT_EFF_DT']) }} AS POSITION_SK,
    POSITION_ID,
    POSITION_DESC,
    EMP_ID,
    MGR_ID,
    SUP_ORG_ID,
    COST_CENTER,
    JOB_CD,
    POSITION_RESTRICTION_WID,
    POSITION_MGMT_WID,
    POSITION_FILLED_WID,
    COMPLETED_CREATE_POSITION_PROCESS_WID,
    STAFFING_STATUS,
    POSITION_OPEN_REASON,
    DYNAMIC_MGMT_LEVEL,
    ORG_ASSIGNMENTS,
    MGR_POSITION,
    COSTING_ALLOCATION_WORKTAGS_FOR_POSITION,
    ADD_EMPLOYMENT_BP,
    ADD_EMPLOYMENT_BP_REASON,
    WORKERS_COMP_CD,
    UNION_MEMBERSHIP,
    ALLOWED_UNIONS,
    FTE,
    FTE_PERCENT,
    SCHEDULED_WEEKLY_HRS,
    WORK_SHIFT,
    COMPANY_INSIDER_TYPES_FOR_POSITION_ELEMENT,
    POSITION_EFF_DT,
    POSITION_VACATE_DT,
    EARLIEST_HIRE_DT,
    AVAILABILITY_DT,
    AVAILABLE_FOR_OVERLAP_IND,
    AVAILABLE_FOR_RECRUITING_IND,
    AVAILABLE_FOR_HIRE_IND,
    CLOSED_TO_HIRE_IND,
    HIRING_RESTRICTIONS_LOCATION,
    HIRING_RESTRICTIONS_POSTION_WORKER_TYPE,
    HIRING_RESTRICTIONS_TIME_TYPE,
    HIRING_REQUIREMENT,
    OPEN_JOB_REQ,
    DIFFICULTY_TO_FILL,
    FROZEN,
    FREEZE_DT,
    FREEZE_REASON,
    HIRING_FREEZE,
    FUTURE_POSITION_FILL_EFF_DT,
    FUTURE_POSITION_FILL_WORKER_EMP_ID,
    HAS_FUTURE_POSITION_FILL_IND,
    HAS_SUCCESSION_PLAN_IND,
    SUCCESSION_PLAN,
    SUCCESSION_READINESS,
    OVERLAPPED_POSITION_IND,
    IS_OVERLAP_POSITION_IND,
    HAS_OVERLAP_WORKER_IND,
    OVERLAP_POSITION,
    OVERLAP_TYPE,
    PAY_GROUP,
    PAY_RATE_TYPE,
    POSITION_COMP_PLAN,
    POSITION_BASE_PAY_RANGE_SEGMENT_EFF,
    POSITION_COMP_GRADE,
    POSITION_COMP_GRADE_PROFILE,
    POSITION_COMP_COMPONENT_TYPES,
    POSITION_COMP_COMPONENTS,
    POSITION_CALC_PLAN_ASSIGNMENT_DTL,
    ACTION_EVENT,
    CREATED_DTM,
    CREATED_BY,
    MOST_RECENT_PAY_GROUP_ASSIGNMENT_CHANGE,
    MOST_RECENT_POSITION_CHANGE,
    MOST_RECENT_SUPERVISORY_ORGANIZATION_CHANGE,
    MOST_RECENT_STAFFING_SNAPSHOT_CHANGE,
    MOST_RECENT_BUSINESS_TITLE_CHANGE,
    MOST_RECENT_PAY_GROUP_CHANGE,
    COMPENSATION_MOST_RECENT_CHANGE_DT,
    RPT_EFF_DT,
    'WKD' AS REC_SRC,
    EFF_DT, 
    CASE when OVL.ovl_position_id is not null
        then case when OVL.FINAL_OVL_DISC_DT is null and OVLF.ovlf_has_overlap_worker_ind = 1
                then '9999-12-31'
                  when OVL.FINAL_OVL_DISC_DT is null and OVLF.ovlf_has_overlap_worker_ind = 0
                then case when (lead(eff_dt) over (order by eff_dt)) = eff_dt
                        then eff_dt
                     else (lead(eff_dt) over (order by eff_dt)) - 1
                     end
             else OVL.FINAL_OVL_DISC_DT
             end
    ELSE COALESCE(FINAL_DISC_DT,'9999-12-31')
    END AS DISC_DT,
    CASE WHEN DISC_DT = '9999-12-31' THEN TRUE ELSE FALSE END AS IS_CURRENT,
    (SELECT TO_NUMBER(TO_VARCHAR(CURRENT_TIMESTAMP, 'YYYYMMDDHH24MISS'))) AS INS_BATCH_ID,
    TO_NUMBER(TO_VARCHAR(CURRENT_TIMESTAMP, 'YYYYMMDDHH24MISS')) AS UPD_BATCH_ID,
    {{ dbt_utils.surrogate_key(['POSITION_DESC','EMP_ID','MGR_ID','SUP_ORG_ID','COST_CENTER','JOB_CD','POSITION_RESTRICTION_WID','POSITION_MGMT_WID','POSITION_FILLED_WID','COMPLETED_CREATE_POSITION_PROCESS_WID','STAFFING_STATUS','POSITION_OPEN_REASON','DYNAMIC_MGMT_LEVEL','ORG_ASSIGNMENTS','MGR_POSITION','COSTING_ALLOCATION_WORKTAGS_FOR_POSITION','ADD_EMPLOYMENT_BP','ADD_EMPLOYMENT_BP_REASON','WORKERS_COMP_CD','UNION_MEMBERSHIP','ALLOWED_UNIONS','FTE','FTE_PERCENT','SCHEDULED_WEEKLY_HRS','WORK_SHIFT','COMPANY_INSIDER_TYPES_FOR_POSITION_ELEMENT','POSITION_EFF_DT','POSITION_VACATE_DT','EARLIEST_HIRE_DT','AVAILABILITY_DT','AVAILABLE_FOR_OVERLAP_IND','AVAILABLE_FOR_RECRUITING_IND','AVAILABLE_FOR_HIRE_IND','CLOSED_TO_HIRE_IND','HIRING_RESTRICTIONS_LOCATION','HIRING_RESTRICTIONS_POSTION_WORKER_TYPE','HIRING_RESTRICTIONS_TIME_TYPE','HIRING_REQUIREMENT','OPEN_JOB_REQ','DIFFICULTY_TO_FILL','FROZEN','FREEZE_DT','FREEZE_REASON','HIRING_FREEZE',
    'FUTURE_POSITION_FILL_EFF_DT','FUTURE_POSITION_FILL_WORKER_EMP_ID','HAS_FUTURE_POSITION_FILL_IND','HAS_SUCCESSION_PLAN_IND','SUCCESSION_PLAN','SUCCESSION_READINESS','OVERLAPPED_POSITION_IND','IS_OVERLAP_POSITION_IND','HAS_OVERLAP_WORKER_IND','OVERLAP_POSITION','OVERLAP_TYPE','PAY_GROUP','PAY_RATE_TYPE','POSITION_COMP_PLAN','POSITION_BASE_PAY_RANGE_SEGMENT_EFF','POSITION_COMP_GRADE','POSITION_COMP_GRADE_PROFILE','POSITION_COMP_COMPONENT_TYPES','POSITION_COMP_COMPONENTS','POSITION_CALC_PLAN_ASSIGNMENT_DTL','ACTION_EVENT','CREATED_DTM','CREATED_BY', 'MOST_RECENT_PAY_GROUP_ASSIGNMENT_CHANGE', 'MOST_RECENT_POSITION_CHANGE',   'MOST_RECENT_SUPERVISORY_ORGANIZATION_CHANGE', 'MOST_RECENT_STAFFING_SNAPSHOT_CHANGE', 'MOST_RECENT_BUSINESS_TITLE_CHANGE', 'MOST_RECENT_PAY_GROUP_CHANGE',
    'COMPENSATION_MOST_RECENT_CHANGE_DT']) }} AS DBT_HASH
FROM FINAL f
LEFT JOIN OVL_FINAL OVL on ovl.ovl_position_id = f.position_id
    and ovl.ovl_eff_dt = f.eff_dt
LEFT JOIN OVL_FINISH OVLF on OVLF.OVLF_POSITION_ID = f.position_id

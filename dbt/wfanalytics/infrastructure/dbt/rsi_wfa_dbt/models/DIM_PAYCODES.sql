{{
    config(
        materialized='table',
        unique_key ='PAYCODE_SK',
        full_refresh =true
        )
}}

WITH
STG_PAYCODES AS (
    SELECT
    PAYCODE AS PAY_CD,
    PAYCODE_TYPE AS PAY_CD_TYPE,
    CALCULATION_CD AS CALC_CD,
    CALCULATION_SOURCE AS CALC_SRC,
    RELATED_CALCULATIONS AS RELATED_CALCS,
    WORKER_ELIGIBILITY AS WORKER_ELIGIBILITY,
    COUNTRY AS COUNTRY,
    PAY_COMPONENT_GROUPS AS PAY_COMPONENT_GROUPS,
    PAYSLIP_NAME AS PAYSLIP_NAME,
    PERIOD_DATE_IND AS PERIOD_DT_IND,
    TAXABLE_WAGES AS TAXABLE_WAGES,
    COMMENT AS COMMENT,
    EFFECTIVE_DT AS EFF_DT,
    CRITERIA_RUN_CATEGORIES AS CRITERIA_RUN_CATEGORIES,
    CRITERIA_PAY_GROUPS AS CRITERIA_PAY_GROUPS,
    COMPENSATION_ELEMENT AS COMP_ELEMENT,
    OVERRIDE_FREQ AS OVERRIDE_FREQ,
    NULL AS OVERRIDE_FREQ_FACTOR,
    CALC_WORKTAG AS CALC_WORKTAG,
    WORKTAG_DIMENSION AS WORKTAG_DIM,
    PRORATION_EVENTS AS PRORATION_EVENTS,
    USED_IND AS USED_IND,
    CALC_IN_USE_IND AS CALC_IN_USE_IND,
    INACTIVE_IND AS INACTIVE_IND,
    ALLOW_INPUT_IND AS ALLOW_INPUT_IND,
    ALLOW_COVERAGE_DATES_BONUSES_IND AS ALLOW_COVERAGE_DTS_BONUSES_IND,
    DO_NOT_RECALC_RETRO_IND AS DO_NOT_RECALC_RETRO_IND,
    FLSA_AMT_ALLOC_COVERAGE_DATES AS FLSA_AMT_ALLOC_COVERAGE_DTS,
    EXCL_FORWARD_ACCRUAL_IND AS EXCL_FORWARD_ACCRUAL_IND,
    GROSS_UP_IND AS GROSS_UP_IND,
    INCL_INPUT_WORKTAGS_IND AS INCL_INPUT_WORKTAGS_IND,
    PRORATE_ANNUAL_WORK_DAYS AS PRORATE_ANNUAL_WORK_DAYS,
    PRORATE_CALENDAR_DAYS AS PRORATE_CALENDAR_DAYS,
    PRORATE_DAYS_WORKED AS PRORATE_DAYS_WORKED,
    RECALC_RETRO_IND AS RECALC_RETRO_IND,
    RESOLVE_FLSA_PERIOD_IND AS RESOLVE_FLSA_PERIOD_IND,
    SCHEDULING_IND AS SCHEDULING_IND,
    NULL AS PRIORITY_IND,
    NULL AS PRIORITY_ORDER,
    NULL AS RPT_EFF_DT,
    SF_INSERT_TIMESTAMP AS SF_INSERT_TIMESTAMP
    FROM {{ source('STAGING','STG_WKD_PAYCODE_EARNINGS') }}

    UNION

    SELECT
    PAYCODE AS PAY_CD,
    PAYCODE_TYPE AS PAY_CD_TYPE,
    CALCULATION_CD AS CALC_CD,
    CALCULATION_SOURCE AS CALC_SRC,
    RELATED_CALCULATIONS AS RELATED_CALCS,
    WORKER_ELIGIBILITY AS WORKER_ELIGIBILITY,
    COUNTRY AS COUNTRY,
    PAY_COMPONENT_GROUPS AS PAY_COMPONENT_GROUPS,
    PAYSLIP_NAME AS PAYSLIP_NAME,
    PERIOD_DATE_IND AS PERIOD_DT_IND,
    TAXABLE_WAGES AS TAXABLE_WAGES,
    COMMENT AS COMMENT,
    EFFECTIVE_DT AS EFF_DT,
    CRITERIA_RUN_CATEGORIES AS CRITERIA_RUN_CATEGORIES,
    CRITERIA_PAY_GROUPS AS CRITERIA_PAY_GROUPS,
    NULL AS COMP_ELEMENT,
    OVERRIDE_FREQ AS OVERRIDE_FREQ,
    OVERRIDE_FREQ_FACTOR AS OVERRIDE_FREQ_FACTOR,
    CALC_WORKTAG AS CALC_WORKTAG,
    WORKTAG_DIMENSION AS WORKTAG_DIM,
    PRORATION_EVENTS AS PRORATION_EVENTS,
    USED_IND AS USED_IND,
    CALC_IN_USE_IND AS CALC_IN_USE_IND,
    INACTIVE_IND AS INACTIVE_IND,
    ALLOW_INPUT_IND AS ALLOW_INPUT_IND,
    NULL AS ALLOW_COVERAGE_DTS_BONUSES_IND,
    NULL AS DO_NOT_RECALC_RETRO_IND,
    NULL AS FLSA_AMT_ALLOC_COVERAGE_DTS,
    EXCL_FORWARD_ACCRUAL_IND AS EXCL_FORWARD_ACCRUAL_IND,
    GROSS_UP_IND AS GROSS_UP_IND,
    INCL_INPUT_WORKTAGS_IND AS INCL_INPUT_WORKTAGS_IND,
    PRORATE_ANNUAL_WORK_DAYS AS PRORATE_ANNUAL_WORK_DAYS,
    PRORATE_CALENDAR_DAYS AS PRORATE_CALENDAR_DAYS,
    PRORATE_DAYS_WORKED AS PRORATE_DAYS_WORKED,
    RECALC_RETRO_IND AS RECALC_RETRO_IND,
    NULL AS RESOLVE_FLSA_PERIOD_IND,
    SCHEDULING AS SCHEDULING_IND,
    PRIORITY_IND AS PRIORITY_IND,
    PRIORITY_ORDER AS PRIORITY_ORDER,
    RPT_EFFECTIVE_DT AS RPT_EFF_DT,
    SF_INSERT_TIMESTAMP AS SF_INSERT_TIMESTAMP
    FROM {{ source('STAGING','STG_WKD_PAYCODE_DEDUCTIONS') }}
)

SELECT
    {{ dbt_utils.surrogate_key(['PAY_CD','PAY_CD_TYPE']) }} AS PAY_CD_SK,
    PAY_CD,
    PAY_CD_TYPE,
    CALC_CD,
    CALC_SRC,
    RELATED_CALCS,
    WORKER_ELIGIBILITY,
    COUNTRY,
    PAY_COMPONENT_GROUPS,
    PAYSLIP_NAME,
    PERIOD_DT_IND,
    TAXABLE_WAGES,
    COMMENT,
    EFF_DT,
    CRITERIA_RUN_CATEGORIES,
    CRITERIA_PAY_GROUPS,
    COMP_ELEMENT,
    OVERRIDE_FREQ,
    OVERRIDE_FREQ_FACTOR,
    CALC_WORKTAG,
    WORKTAG_DIM,
    PRORATION_EVENTS,
    USED_IND,
    CALC_IN_USE_IND,
    INACTIVE_IND,
    ALLOW_INPUT_IND,
    ALLOW_COVERAGE_DTS_BONUSES_IND,
    DO_NOT_RECALC_RETRO_IND,
    FLSA_AMT_ALLOC_COVERAGE_DTS,
    EXCL_FORWARD_ACCRUAL_IND,
    GROSS_UP_IND,
    INCL_INPUT_WORKTAGS_IND,
    PRORATE_ANNUAL_WORK_DAYS,
    PRORATE_CALENDAR_DAYS,
    PRORATE_DAYS_WORKED,
    RECALC_RETRO_IND,
    RESOLVE_FLSA_PERIOD_IND,
    SCHEDULING_IND,
    PRIORITY_IND,
    PRIORITY_ORDER,
    RPT_EFF_DT,
    TO_NUMBER(TO_VARCHAR(CURRENT_TIMESTAMP, 'YYYYMMDDHH24MISS')) as INS_BATCH_ID,
    TO_NUMBER(to_varchar(CURRENT_TIMESTAMP, 'YYYYMMDDHH24MISS')) AS UPD_BATCH_ID,
    'WKD' AS REC_SRC
FROM STG_PAYCODES
QUALIFY ROW_NUMBER() OVER(PARTITION BY PAY_CD, PAY_CD_TYPE ORDER BY SF_INSERT_TIMESTAMP DESC) = 1




